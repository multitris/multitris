<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>multitris - playing</title>
		<style type="text/css">
			body {
				background-color: black;
				color: red;
			}

			div#messages {
				padding: 10px;
				border-color: orange;
				border-width: 1px;
				border-style: solid;
				background-color: #222222;
			}

			div.message {
				margin: 0px;
				padding: 0px;
			}

		</style>
		<script type="text/javascript">
			cookie= parseInt(Math.random()*4294967296);
			function command(send)
			{
				var xmlHttp = null;
				// Mozilla, Opera, Safari sowie Internet Explorer 7
				if (typeof XMLHttpRequest != 'undefined') {
					xmlHttp = new XMLHttpRequest();
				}
				if (!xmlHttp) {
					// Internet Explorer 6 und Ã¤lter
					try {
					xmlHttp  = new ActiveXObject("Msxml2.XMLHTTP");
					} catch(e) {
					try {
						xmlHttp  = new ActiveXObject("Microsoft.XMLHTTP");
					} catch(e) {
						xmlHttp  = null;
					}
					}
				}
				if (xmlHttp) {
					xmlHttp.onreadystatechange = function () {
						if (xmlHttp.readyState == 4) {
							receive_command(xmlHttp.responseText);
						}
					};
					xmlHttp.open('POST', '/command');
					xmlHttp.send(cookie + " " + send);
				}
			}

			function message(text) {
				div= document.getElementById("messages");
				div.removeChild(div.firstChild);
				d= document.createElement("div");
				d.innerHTML= text;
				div.appendChild(d);
			}

			document.onkeydown= function (e) {
				switch(e.keyCode) {
				case 32:
					command("TURN");
					break;
				case 37:
					command("LAFONTAINE");
					break;
				case 38:
					command("MARIHUANA");
					break;
				case 39:
					command("STOIBER");
					break;
				case 40:
					command("MOELLEMAN");
				}
			};

			login= false;
			function receive_command(cmd) {
				if (cmd.substring(0, 9) == "ATTENTION") {
					if (!login) {
						login= true;
						message("logged in");
						message("Use the arrow keys and space to play");
					}
					message("Your color is <div style=\"display: inline-block; width: 12px; height: 12px; border-color: white; border-style: solid; border-width: 1px; background-color: " + cmd.substring(10, 16) + "; color: " + cmd.substring(10, 16) + "; \"><\/div>");
				} else if (cmd.substring(0, 7) == "FUCKYOU") {
					message("connection lost: " + cmd.substring (8, cmd.length));
					exit();
				} else if (cmd.substring(0, 5) == "CHUCK") {
					command("NORRIS " + cmd.substring(6, cmd.length));
				} else if (cmd == "NOTBAD") {
					message("You won!");
				} else if (cmd == "THATWASMISERABLE") {
					message("You lost");
				}
			}

			end= false;
			function exit() {
				end= true;
			}

			window.onload= function () {
				message("establishing connection");
				command("COOKIE " + cookie);
				setTimeout("login1()", 600);
				setTimeout("keepalive()", 500);
			}

			function keepalive() {
				if (end) {
					return;
				}
				command("");
				setTimeout("keepalive()", 500);
			}

			function login1() {
				if (end) {
					return;
				}
				message("<form style=\"display: inline\" onsubmit=\"login2(); return false;\">name: <input type=\"text\" id=\"player_name\" \/><input id=\"login_submit\" type=\"submit\" value=\"login\" \/><\/form>");
			}

			function login2() {
				if (end) {
					return;
				}
				value= document.getElementById("player_name").value
				if (value != "") {
					document.getElementById("player_name").disabled= true;
					document.getElementById("login_submit").disabled= true;
					message("logging in");
					command("IWANTFUN 0.1 "+value);
				}
			}
		</script>
	</head>
	<body>
		<div id="messages">
			<div class="message"></div>
			<div class="message"></div>
			<div class="message"></div>
			<div class="message"></div>
			<div class="message"></div>
			<div class="message"></div>
			<div class="message"></div>
			<div class="message"></div>
			<div class="message"></div>
			<div class="message"></div>
		</div>
		<p>
		</p>
	</body>
</html>
