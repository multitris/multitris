#!/usr/bin/ruby
#
# Author:: Johannes Krude
# Copyright:: (c) Johannes Krude 2008
# License:: AGPL3
#
#--
# This file is part of multitris.
#
# multitris is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# multitris is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with multitris.  If not, see <http://www.gnu.org/licenses/>.
#++

PORT= 12345

require 'client'
require 'httpserver'
require 'pathname'

if ARGV.size != 2
	STDERR.puts "usage: ./ruby-web server port"
	exit 1
end

users= Hash.new
answers= Hash.new

webserver= HTTPServer.new("multitris-web")
webserver.listen(PORT) do |filename, vars|
	begin
		case filename
		when "command"
			vars["post-data"]=~ /^(\w+) (.*?)$/
			cookie= $1
			command= $2
			if (command=~ /^COOKIE (\w+)$/) # new connection
				puts command
				next "ERROR" unless $1 == cookie
				users[cookie]= Multitris::Client.new
				users[cookie].connect(ARGV[0], ARGV[1]) do |message|
					answers[users].call(message) if answers[users]
				end
			else
				next "ERROR" unless users[cookie]
				case command
				when /^IWANTFUN [^ ]+ .*?$/
				when "LAFONTAINE"
					users[cookie].left
				when "STOIBER"
					users[cookie].right
				when "TURN"
					users[cookie].turn
				end
			end
			"OK"
		else
			HTTPServer::put_file("play.html", "text/html")
		end
	rescue
	end
end
client= Multitris::Client.new

